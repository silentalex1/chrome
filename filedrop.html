<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>xtendify</title>
  <link rel="stylesheet" href="filedrop.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="background-animation"></div>
  
  <nav class="navbar">
    <div class="nav-left">
      <div class="logo">
        <span class="logo-icon">ğŸ“</span>
        <span class="logo-text">xtendify</span>
      </div>
    </div>
    <div class="nav-right">
      <button class="nav-btn" id="logoutBtn">
        <span class="btn-icon">ğŸšª</span>
        <span>Logout</span>
      </button>
    </div>
  </nav>

  <main class="main-content">
    <div class="content-wrapper">
      <div class="upload-section">
        <div class="upload-header">
          <h1>Share Files Instantly</h1>
          <p>Drag and drop or click to upload your files</p>
        </div>
        
        <div class="drop-zone" id="dropZone">
          <div class="drop-content">
            <div class="upload-icon" id="uploadIcon">
              <div class="icon-cloud">â˜ï¸</div>
              <div class="icon-arrow">â¬†ï¸</div>
            </div>
            <div class="drop-text" id="dropText">
              <h3>Drop your files here</h3>
              <p>or click to browse</p>
            </div>
            <input type="file" id="fileInput" multiple style="display:none">
          </div>
          
          <div class="upload-progress" id="uploadProgress" style="display:none">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Uploading...</div>
          </div>
        </div>
      </div>

      <div class="files-section">
        <div class="section-header">
          <h2>Your Files</h2>
          <button class="refresh-btn" id="refreshBtn">
            <span class="btn-icon">ğŸ”„</span>
            <span>Refresh</span>
          </button>
        </div>
        
        <div class="files-list" id="filesList">
          <div class="empty-state" id="emptyState">
            <div class="empty-icon">ğŸ“‚</div>
            <h3>No files yet</h3>
            <p>Upload your first file to get started</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="notification" id="notification"></div>

  <div class="modal-overlay" id="modalOverlay" style="display:none">
    <div class="modal" id="propertiesModal">
      <div class="modal-header">
        <div class="modal-icon">ğŸ“„</div>
        <h2>File Details</h2>
        <button class="modal-close" id="modalClose">âœ•</button>
      </div>
      
      <div class="modal-content">
        <div class="file-info-header">
          <div class="file-icon-large">ğŸ“„</div>
          <h3 id="modalFileName">filename.ext</h3>
        </div>
        
        <div class="info-section">
          <div class="section-header-info">
            <span class="section-icon">â„¹ï¸</span>
            <h4>General Information</h4>
          </div>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-icon">ğŸ·ï¸</span>
              <span class="info-label">Type:</span>
              <span class="info-value" id="modalFileType">file</span>
            </div>
            <div class="info-item">
              <span class="info-icon">ğŸ“…</span>
              <span class="info-label">Created:</span>
              <span class="info-value" id="modalFileCreated">-</span>
            </div>
            <div class="info-item">
              <span class="info-icon">ğŸ†”</span>
              <span class="info-label">ID:</span>
              <span class="info-value" id="modalFileId">-</span>
              <button class="copy-btn" data-copy="modalFileId">ğŸ“‹</button>
            </div>
          </div>
        </div>
        
        <div class="info-section">
          <div class="section-header-info">
            <span class="section-icon">ğŸ“Š</span>
            <h4>File Information</h4>
          </div>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-icon">ğŸ“</span>
              <span class="info-label">Size:</span>
              <span class="info-value" id="modalFileSize">-</span>
            </div>
            <div class="info-item">
              <span class="info-icon">â¬‡ï¸</span>
              <span class="info-label">Downloads:</span>
              <span class="info-value" id="modalFileDownloads">0</span>
            </div>
            <div class="info-item">
              <span class="info-icon">ğŸ”—</span>
              <span class="info-label">MIME Type:</span>
              <span class="info-value" id="modalFileMime">-</span>
            </div>
            <div class="info-item">
              <span class="info-icon">ğŸ”¢</span>
              <span class="info-label">MD5:</span>
              <span class="info-value" id="modalFileMd5">-</span>
              <button class="copy-btn" data-copy="modalFileMd5">ğŸ“‹</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentFiles = [];
    const dropZone = document.getElementById('dropZone');
    const uploadIcon = document.getElementById('uploadIcon');
    const dropText = document.getElementById('dropText');
    const fileInput = document.getElementById('fileInput');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const filesList = document.getElementById('filesList');
    const emptyState = document.getElementById('emptyState');
    const notification = document.getElementById('notification');
    const logoutBtn = document.getElementById('logoutBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const modalOverlay = document.getElementById('modalOverlay');
    const propertiesModal = document.getElementById('propertiesModal');
    const modalClose = document.getElementById('modalClose');

    function showNotification(message, type = 'info') {
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.style.display = 'block';
      setTimeout(() => {
        notification.style.display = 'none';
      }, 4000);
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatDate(date) {
      return new Intl.DateTimeFormat('en-US', {
        month: 'numeric',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
      }).format(new Date(date));
    }

    function generateRandomId() {
      return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
    }

    function generatePublishLink() {
      const randomId = generateRandomId();
      return `xtendify.wtf/xtendify_${randomId}`;
    }

    function createFileItem(file) {
      const item = document.createElement('div');
      item.className = 'file-item';
      item.innerHTML = `
        <div class="file-checkbox">
          <input type="checkbox" id="check_${file.id}">
          <label for="check_${file.id}"></label>
        </div>
        <div class="file-icon">ğŸ“„</div>
        <div class="file-info">
          <div class="file-name">${file.name}</div>
          <div class="file-meta">
            <span>${formatDate(file.uploaded || Date.now())}</span>
            <span>${formatFileSize(file.size || 0)}</span>
          </div>
        </div>
        <div class="file-actions">
          <button class="action-btn download-btn" data-link="${file.link}" title="Download">
            <span class="btn-icon">â¬‡ï¸</span>
            <span>Download</span>
          </button>
          <div class="dropdown">
            <button class="dropdown-btn" title="More options">
              <span class="btn-icon">â‹®</span>
            </button>
            <div class="dropdown-menu">
              <button class="dropdown-item" data-action="download" data-link="${file.link}">
                <span class="item-icon">â¬‡ï¸</span>
                <span>Download</span>
              </button>
              <button class="dropdown-item" data-action="import" data-id="${file.id}">
                <span class="item-icon">ğŸ“¥</span>
                <span>Import</span>
              </button>
              <button class="dropdown-item" data-action="properties" data-id="${file.id}">
                <span class="item-icon">â„¹ï¸</span>
                <span>Properties</span>
              </button>
              <div class="dropdown-separator"></div>
              <button class="dropdown-item" data-action="publish" data-id="${file.id}">
                <span class="item-icon">ğŸŒ</span>
                <span>Publish Project</span>
              </button>
            </div>
          </div>
        </div>
      `;
      return item;
    }

    function renderFiles(files) {
      filesList.innerHTML = '';
      
      if (files.length === 0) {
        filesList.appendChild(emptyState);
        emptyState.style.display = 'flex';
        return;
      }
      
      emptyState.style.display = 'none';
      files.forEach(file => {
        const item = createFileItem(file);
        filesList.appendChild(item);
      });
    }

    async function loadFiles() {
      try {
        const response = await fetch('/files');
        if (response.ok) {
          const files = await response.json();
          currentFiles = files;
          renderFiles(files);
        }
      } catch (error) {
        showNotification('Failed to load files', 'error');
      }
    }

    async function uploadFile(file) {
      const formData = new FormData();
      formData.append('file', file);
      
      uploadProgress.style.display = 'block';
      dropZone.classList.add('uploading');
      
      try {
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            progressFill.style.width = percentComplete + '%';
            progressText.textContent = `Uploading ${Math.round(percentComplete)}%`;
          }
        });
        
        xhr.addEventListener('load', () => {
          if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            showNotification('File uploaded successfully!', 'success');
            loadFiles();
          } else {
            showNotification('Upload failed', 'error');
          }
          uploadProgress.style.display = 'none';
          dropZone.classList.remove('uploading');
          progressFill.style.width = '0%';
        });
        
        xhr.addEventListener('error', () => {
          showNotification('Upload failed', 'error');
          uploadProgress.style.display = 'none';
          dropZone.classList.remove('uploading');
          progressFill.style.width = '0%';
        });
        
        xhr.open('POST', '/upload');
        xhr.send(formData);
        
      } catch (error) {
        showNotification('Upload failed', 'error');
        uploadProgress.style.display = 'none';
        dropZone.classList.remove('uploading');
      }
    }

    function handleFiles(files) {
      Array.from(files).forEach(file => {
        uploadFile(file);
      });
    }

    function showPropertiesModal(file) {
      document.getElementById('modalFileName').textContent = file.name;
      document.getElementById('modalFileType').textContent = 'file';
      document.getElementById('modalFileCreated').textContent = formatDate(file.uploaded || Date.now());
      document.getElementById('modalFileId').textContent = file.id;
      document.getElementById('modalFileSize').textContent = formatFileSize(file.size || 0);
      document.getElementById('modalFileDownloads').textContent = file.downloads || 0;
      document.getElementById('modalFileMime').textContent = file.mimeType || 'application/octet-stream';
      document.getElementById('modalFileMd5').textContent = file.md5 || generateRandomId();
      
      modalOverlay.style.display = 'flex';
    }

    function closeModal() {
      modalOverlay.style.display = 'none';
    }

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
      dropText.innerHTML = '<h3>Drop to upload</h3><p>Release to upload your files</p>';
    });

    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      dropText.innerHTML = '<h3>Drop your files here</h3><p>or click to browse</p>';
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      dropText.innerHTML = '<h3>Drop your files here</h3><p>or click to browse</p>';
      handleFiles(e.dataTransfer.files);
    });

    dropZone.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
      fileInput.value = '';
    });

    filesList.addEventListener('click', (e) => {
      if (e.target.closest('.download-btn')) {
        const link = e.target.closest('.download-btn').dataset.link;
        window.open(link, '_blank');
      } else if (e.target.closest('.dropdown-btn')) {
        const dropdown = e.target.closest('.dropdown');
        dropdown.classList.toggle('active');
      } else if (e.target.closest('.dropdown-item')) {
        const item = e.target.closest('.dropdown-item');
        const action = item.dataset.action;
        const fileId = item.dataset.fileId;
        const link = item.dataset.link;
        
        const dropdown = item.closest('.dropdown');
        dropdown.classList.remove('active');
        
        if (action === 'download') {
          window.open(link, '_blank');
        } else if (action === 'import') {
          showNotification('Import functionality coming soon', 'info');
        } else if (action === 'properties') {
          const file = currentFiles.find(f => f.id === fileId);
          if (file) showPropertiesModal(file);
        } else if (action === 'publish') {
          const publishLink = generatePublishLink();
          navigator.clipboard.writeText(publishLink);
          showNotification('Project published! Link copied to clipboard: ' + publishLink, 'success');
        }
      }
    });

    modalClose.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay) closeModal();
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.dropdown')) {
        document.querySelectorAll('.dropdown').forEach(dropdown => {
          dropdown.classList.remove('active');
        });
      }
    });

    logoutBtn.addEventListener('click', () => {
      fetch('/logout', { method: 'POST' });
      window.location.href = '/';
    });

    refreshBtn.addEventListener('click', () => {
      loadFiles();
      showNotification('Files refreshed', 'info');
    });

    loadFiles();
  </script>
</body>
</html>